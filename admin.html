<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Ironwood Admin</title>
  <meta name="robots" content="noindex, nofollow">
  <style>
    :root{
      --bg:#050816;--surface:#0b1120;--card:#0b1120;--border:#1f2937;
      --muted:#9ca3af;--text:#e5e7eb;--brand:#dc2626;--accent:#f97316;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:radial-gradient(circle at top,#111827 0,#020617 55%);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,sans-serif;}
    a{color:inherit;text-decoration:none}a:hover{text-decoration:underline}
    .container{width:min(1100px,92vw);margin-inline:auto}
    header{border-bottom:1px solid var(--border);background:linear-gradient(to bottom,rgba(15,23,42,.94),rgba(15,23,42,.7),transparent);backdrop-filter:blur(12px);position:sticky;top:0;z-index:20}
    .bar{display:flex;align-items:center;justify-content:space-between;width:min(1100px,92vw);margin:0 auto;padding:.7rem 0;gap:.8rem}
    .brand{display:flex;align-items:center;gap:.5rem;font-weight:800;letter-spacing:.06em;text-transform:uppercase;color:var(--text)}
    .brand img{height:42px}
    .brand-name{padding:2px 8px;border:1px solid rgba(248,113,113,.6);border-radius:12px;background:rgba(248,113,113,.08);letter-spacing:.04em}
    .brand-tag{padding:2px 8px;border:1px solid rgba(248,113,113,.6);border-radius:999px;font-size:12px;letter-spacing:.08em;color:var(--text)}
    nav{display:flex;align-items:center;gap:.5rem;font-size:.9rem}
    nav a{color:var(--muted);padding:.4rem .65rem;border-radius:10px}
    nav a:hover{color:var(--text);background:rgba(220,38,38,.1)}
    .card{background:linear-gradient(160deg,rgba(15,23,42,.92),rgba(11,17,32,.9));border:1px solid var(--border);border-radius:18px;padding:1rem;margin-top:16px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .grid{display:grid;grid-template-columns:160px 1fr;gap:10px;align-items:center}
    input,textarea{width:100%;padding:.55rem .7rem;border-radius:10px;border:1px solid #1f2937;background:#0f172a;color:var(--text)}
    textarea{min-height:80px}
    .btn{display:inline-flex;gap:.6rem;align-items:center;background:linear-gradient(145deg,#1f2937,#0f172a);color:#ffdddd;padding:.65rem 1rem;border-radius:10px;font-weight:700;border:1px solid rgba(220,38,38,.45);cursor:pointer;box-shadow:0 0 0 rgba(220,38,38,.25);transition:transform .08s ease,box-shadow .12s ease,filter .12s ease,border-color .12s ease}
    .btn:hover{filter:brightness(1.05);border-color:rgba(252,165,165,.9);box-shadow:0 0 14px rgba(220,38,38,.4);transform:translateY(-1px)}
    .btn:active{transform:translateY(0)}
    .btn.ghost{background:linear-gradient(145deg,#0f172a,#0b1220);border:1px solid #2b333b;color:var(--text);box-shadow:none}
    .btn.ghost:hover{border-color:rgba(220,38,38,.5);box-shadow:0 0 10px rgba(220,38,38,.32);filter:brightness(1.02);transform:translateY(-1px)}
    .muted{color:var(--muted)}
    .badge{padding:4px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.15);background:#5b1a1a}
    .hr{height:1px;background:var(--border);margin:.8rem 0}
    footer{border-top:1px solid var(--border);background:#020617;margin-top:40px}
    footer .footer-inner{max-width:960px;margin:0 auto;padding:1.5rem 1rem 2rem;display:grid;gap:1rem;grid-template-columns:minmax(0,1fr)}
    @media(min-width:640px){footer .footer-inner{grid-template-columns:repeat(3,minmax(0,1fr));}}
    .photo-list img{width:72px;height:48px;object-fit:cover;border-radius:6px;border:1px solid #1a2128}
    .toast{
      position:fixed;right:16px;bottom:16px;
      background:#0f172a;
      border:1px solid #1f2937;
      border-radius:12px;
      padding:.7rem 1rem;
      display:none;
      box-shadow:0 10px 30px rgba(0,0,0,0.35);
      z-index:9999;
    }
    .toast.ok{background:#0f1a14;border-color:#1c3a2c}
    .toast.err{background:#1a1010;border-color:#3a1c1c}
    @media(max-width:720px){
      .bar{flex-direction:column;align-items:flex-start;}
      nav{flex-wrap:wrap;width:100%;gap:.4rem}
      nav a{width:auto;padding:.45rem .65rem;border-radius:10px;background:rgba(15,23,42,.7)}
      nav a:last-child{margin-left:0}
      .grid{grid-template-columns:1fr}
      .row{flex-direction:column}
    }
  </style>
</head>
<body>
  <header class="topbar">
    <div class="bar">
      <a class="brand" href="index.html">
        <img src="assets/logo-ld-original.png" alt="">
        <span class="brand-name">Ironwood Land Development</span>
        <span class="brand-tag">NE LA</span>
      </a>
      <nav>
        <a href="index.html#services">Services</a>
        <a href="index.html#equipment">Equipment</a>
        <a href="dumpsters.html">Dumpsters</a>
        <a href="contact.html">Contact</a>
        <a href="admin.html" style="color:#e5e7eb">Admin</a>
      </nav>
    </div>
  </header>

  <div class="container" style="padding:24px 0 80px">

    <div class="card">
      <h2>Connect (Worker)</h2>
      <p class="muted">Use your Cloudflare Worker so PAT stays off the browser.</p>
      <div class="grid">
        <label>Worker URL</label><input id="cf_url" placeholder="https://your-worker.workers.dev">
        <label>Worker Key</label><input id="cf_key" type="password" placeholder="ADMIN_KEY">
      </div>
      <div class="row" style="margin-top:10px;align-items:center">
        <button id="cf_save" class="btn" type="button">Save</button>
        <button id="cf_test" class="btn ghost" type="button">Test</button>
        <span id="cf_status" class="badge">Not set</span>
      </div>
      <small class="muted">If you leave these blank, GitHub mode is used (Owner/Repo/Token below).</small>
    </div>

    <div class="card">
      <h2>GitHub (fallback)</h2>
      <div class="grid">
        <label>Owner</label><input id="gh_owner" placeholder="jonathonparker21-rgb">
        <label>Repo</label><input id="gh_repo" placeholder="ironwood-content">
        <label>Branch</label><input id="gh_branch" value="main" placeholder="main">
        <label>PAT</label><input id="gh_token" type="password" placeholder="Fine-grained PAT (Contents: Read/Write)">
      </div>
      <div class="row" style="margin-top:10px;align-items:center">
        <button id="gh_save" class="btn" type="button">Save</button>
        <button id="gh_test" class="btn ghost" type="button">Test</button>
        <span id="gh_status" class="badge">Not set</span>
      </div>
      <small class="muted">Stored only in your browser (localStorage).</small>
    </div>

    <div class="card">
      <h2>Equipment Photos</h2>
      <div class="row">
        <input id="equip_photos" type="file" accept="image/*" multiple>
        <button id="equip_upload" class="btn">Upload</button>
      </div>
      <div class="hr"></div>
      <div id="equip_list" class="photo-list muted">Loading…</div>
    </div>

    <div class="card">
      <h2>Dumpsters Photos</h2>
      <div class="row">
        <input id="dump_photos" type="file" accept="image/*" multiple>
        <button id="dump_upload" class="btn">Upload</button>
      </div>
      <div class="hr"></div>
      <div id="dump_list" class="photo-list muted">Loading…</div>
    </div>

  </div>

  <footer>
    <div class="footer-inner">
      <div><strong>Ironwood Land Development</strong><br><span class="muted">Professional land development: clearing, grading, demolition, and dumpsters.</span></div>
      <div><strong>Phone:</strong> (318) 914-2351<br><span class="muted">Mon–Sat 7a–6p</span></div>
      <div><strong>Address:</strong> 805 E. Main St, Oak Grove, LA 71263</div>
    </div>
  </footer>

  <div id="toast" class="toast"></div>

  <script>
    const $=id=>document.getElementById(id);
    function toast(msg,ok=true){const t=$('toast');t.textContent=msg;t.className='toast '+(ok?'ok':'err');t.style.display='block';clearTimeout(window.__t);window.__t=setTimeout(()=>{t.style.display='none'},3000);}
    function badge(id,txt,ok){const el=$(id);if(el){el.textContent=txt;el.style.background=ok?'#065f46':'#5b1a1a';}}

    function state(){
      const defaults = {gh_owner:'jonathonparker21-rgb', gh_repo:'ironwood-content', gh_branch:'main'};
      try{
        const gh=JSON.parse(localStorage.getItem('ironwood_gh')||'{}');
        return {
          gh_owner:gh.owner||defaults.gh_owner,
          gh_repo:gh.repo||defaults.gh_repo,
          gh_branch:gh.branch||defaults.gh_branch,
          gh_token:localStorage.getItem('ironwood_gh_token')||'',
          cf_url:localStorage.getItem('ironwood_cf_url')||'',
          cf_key:localStorage.getItem('ironwood_cf_key')||''
        };
      }catch(_){return{...defaults,gh_token:'',cf_url:'',cf_key:''};}
    }
    function saveState(next){localStorage.setItem('ironwood_gh',JSON.stringify({owner:next.gh_owner,repo:next.gh_repo,branch:next.gh_branch}));localStorage.setItem('ironwood_gh_token',next.gh_token||'');localStorage.setItem('ironwood_cf_url',next.cf_url||'');localStorage.setItem('ironwood_cf_key',next.cf_key||'');}
    function useWorker(){const s=state();return !!(s.cf_url && s.cf_key);}

    async function api(path, method='GET', payload=null, isBase64=false){
      const s=state();
      const trimBranch = s.gh_branch || 'main';

      // Helper: GitHub direct
      async function viaGitHub() {
        const ghHeaders = {'Content-Type':'application/json'};
        if(s.gh_token) ghHeaders['Authorization']='Bearer '+s.gh_token;
        // Preserve nested paths (encode each segment, not the slash).
        const basePath = path.replace(/^\/+/,'').split('/').map(encodeURIComponent).join('/');
        const base = `https://api.github.com/repos/${s.gh_owner}/${s.gh_repo}/contents/${basePath}?ref=${encodeURIComponent(trimBranch)}`;
        if(method==='GET'){
          const r=await fetch(base,{headers:ghHeaders,cache:'no-store'});
          if(r.status === 404) return null;
          if(!r.ok) throw new Error('GitHub GET failed: '+r.status+' '+(await r.text()));
          return r.json();
        }
        if(method==='DELETE'){
          const existing=await api(path,'GET'); const sha=existing?.sha; if(!sha) throw new Error('Not found');
          const r=await fetch(base,{method:'DELETE',headers:ghHeaders,body:JSON.stringify({message:payload?.message||'delete '+path,sha,branch:trimBranch})});
          if(!r.ok) throw new Error('GitHub DELETE failed: '+r.status+' '+(await r.text()));
          return true;
        }
        const existing = await api(path,'GET').catch(()=>null);
        const isB64 = isBase64 || !!payload?.base64;
        const body = {
          message: payload?.message || ('update '+path),
          content: isB64 ? (payload?.content || '') : btoa(unescape(encodeURIComponent(payload?.text || ''))),
          branch: trimBranch
        };
        if(existing && existing.sha) body.sha = existing.sha;
        const r=await fetch(base,{method:'PUT',headers:ghHeaders,body:JSON.stringify(body)});
        if(!r.ok) throw new Error('GitHub PUT failed: '+r.status+' '+(await r.text()));
        return r.json();
      }

      // Prefer worker if set; otherwise GitHub. If worker fails and GitHub creds exist, fallback for GET.
      if(useWorker()){
        try{
          const url = s.cf_url.replace(/\/$/,'') + '?path=' + encodeURIComponent(path);
          const headers = {'Authorization':'Bearer '+s.cf_key};
          if(payload) headers['Content-Type']='application/json';
          const body = payload ? JSON.stringify(payload) : undefined;
          const r = await fetch(url,{method,headers,body});
          if(r.status === 404) return null;
          if(!r.ok){
            const txt = await r.text();
            throw new Error('Worker '+method+' '+path+' failed: '+r.status+' '+txt);
          }
          if(method==='DELETE') return true;
          return await r.json();
        }catch(err){
          // Allow transparent GitHub fallback for GET if available
          if(method==='GET' && (s.gh_owner || s.gh_repo)){
            console.warn('Worker failed, trying GitHub fallback', err);
            return viaGitHub();
          }
          throw err;
        }
      }
      return viaGitHub();
    }

    async function listDir(prefix, target){
      try{
        const dir = await api(prefix,'GET');
        if(Array.isArray(dir)){
          if(!dir.length){target.innerHTML='<p class="muted">No photos yet.</p>'; return [];}
          const files = dir
            .filter(x=>x.name && x.name!=='.keep')
            .filter(x=>!x.name.endsWith('.json')) // hide index/config files
            .map(x=>prefix.replace(/\/$/,'')+'/'+x.name);
          target.innerHTML = files.map(p=>`<div style="display:flex;align-items:center;gap:10px;margin:.3rem 0;border:1px solid #1a2128;padding:.3rem .5rem;border-radius:8px"><img src="${p}" alt=""><code style="flex:1">${p}</code><button class="btn ghost" onclick="deletePhoto('${p.replace(/^\//,'')}', '${prefix}', '${target.id}')">Delete</button></div>`).join('');
          return files;
        }
        if(Array.isArray(dir?.content)){
          const files = (dir.content||[]).filter(Boolean);
          target.innerHTML = files.map(p=>`<div style="display:flex;align-items:center;gap:10px;margin:.3rem 0;border:1px solid #1a2128;padding:.3rem .5rem;border-radius:8px"><img src="${p}" alt=""><code style="flex:1">${p}</code><button class="btn ghost" onclick="deletePhoto('${p.replace(/^\//,'')}', '${prefix}', '${target.id}')">Delete</button></div>`).join('');
          return files;
        }
        target.innerHTML='<p class="muted">No photos yet.</p>';
        return [];
      }catch(e){
        target.innerHTML=`<p class="muted">Error loading list: ${e.message}</p>`;
        return [];
      }
    }
    window.deletePhoto = async function(relPath, prefix, targetId){
      try{
        await api(relPath.replace(/^\//,''), 'DELETE', {message:'delete '+relPath});
        await listDir(prefix, document.getElementById(targetId));
        toast('Photo deleted', true);
      }catch(e){ toast('Delete failed: '+e.message, false); }
    };

    async function uploadPhotos(inputId, folder, targetId, cfgKey){
      try{
        const inp=$(inputId); const files=Array.from(inp.files||[]); if(!files.length) return toast('Pick images to upload', false);
        // ensure folder
        await api(folder+'/.keep','POST',{text:'keep',message:'ensure folder'});
        for(const f of files){
          const dataUrl = await new Promise((res,rej)=>{const fr=new FileReader(); fr.onload=()=>res(fr.result); fr.onerror=rej; fr.readAsDataURL(f);});
          const b64 = String(dataUrl).split(',')[1]||'';
          const safe = (Date.now()+'-'+f.name.replace(/\s+/g,'_'));
          await api(folder+'/'+safe,'POST',{content:b64,base64:true,message:'upload '+folder}, true);
        }
        const listEl=$(targetId);
        const filesList = await listDir(folder, listEl);
        // update config entry
        try{
          const cfg = await api('config.json','GET');
          const parsed = cfg && cfg.content ? JSON.parse(atob(cfg.content)) : cfg;
          if(parsed){
            parsed[cfgKey] = filesList.map(p=>p.startsWith('/')?p:('/'+p));
            await api('config.json','POST',{text:JSON.stringify(parsed,null,2),message:'admin: update '+cfgKey});
          }
        }catch(_){}
        inp.value='';
        toast('Photos uploaded ✅', true);
      }catch(e){ toast('Upload failed: '+e.message,false); }
    }

    (function init(){
    const s=state();
    $('cf_url').value=s.cf_url; $('cf_key').value=s.cf_key;
    $('gh_owner').value=s.gh_owner; $('gh_repo').value=s.gh_repo; $('gh_branch').value=s.gh_branch; $('gh_token').value=s.gh_token;
      badge('cf_status', (s.cf_url&&s.cf_key)?'Saved (worker)':'Not set', !!(s.cf_url&&s.cf_key));
      badge('gh_status', (s.gh_owner&&s.gh_repo&&s.gh_token)?'Saved':'Not set', !!(s.gh_owner&&s.gh_repo&&s.gh_token));
    })();

    $('cf_save').onclick=()=>{
      const cf_url=$('cf_url').value.trim(), cf_key=$('cf_key').value.trim();
      saveState(Object.assign(state(),{cf_url,cf_key}));
      if(cf_url && cf_key){ badge('cf_status','Saved (worker)',true); toast('Worker connection saved ✅',true);} else { badge('cf_status','Not set',false); toast('Worker URL/key missing',false); }
    };
    $('cf_test').onclick=async()=>{
      try{
        if(!useWorker()) throw new Error('Set worker URL/key first');
        await api('config.json','GET');
        badge('cf_status','OK',true); toast('Worker reachable ✅',true);
      }catch(e){ badge('cf_status','Failed',false); toast('Worker test failed: '+e.message,false); }
    };
    $('gh_save').onclick=()=>{
      const owner=$('gh_owner').value.trim(),repo=$('gh_repo').value.trim(),branch=($('gh_branch').value.trim()||'main'),token=$('gh_token').value.trim();
      if(!owner||!repo||!token){ badge('gh_status','Missing',false); return toast('Owner/Repo/Token required (or use Worker)',false); }
      saveState(Object.assign(state(),{gh_owner:owner,gh_repo:repo,gh_branch:branch,gh_token:token}));
      badge('gh_status','Saved',true); toast('GitHub connection saved ✅',true);
    };
    $('gh_test').onclick=async()=>{
      try{
        await api('config.json','GET');
        badge('gh_status','OK',true); toast('Reachable ✅',true);
      }catch(e){ badge('gh_status','Failed',false); toast('Test failed: '+e.message,false); }
    };

    $('equip_upload').onclick=()=>uploadPhotos('equip_photos','equipment/photos','equip_list','equipment_photos');
    $('dump_upload').onclick=()=>uploadPhotos('dump_photos','dumpsters/photos','dump_list','dumpster_photos');
    (async()=>{ await listDir('equipment/photos', $('equip_list')); await listDir('dumpsters/photos', $('dump_list')); })();
  </script>
</body>
</html>
