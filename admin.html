<!doctype html><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Ironwood Admin</title>
<style>
:root{--bg:#0b0e11;--surface:#12161a;--muted:#8c98a4;--text:#eef2f6;--brand:#dc2626;--accent:#fca5a5}
*{box-sizing:border-box}html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui}
.container{width:min(1100px,92vw);margin-inline:auto}
.card{background:#12161a;border:1px solid #1a2128;border-radius:18px;padding:1rem}
h2{margin:.2rem 0 0.8rem 0}
.row{display:flex;gap:10px;flex-wrap:wrap}
.grid{display:grid;grid-template-columns:160px 1fr;gap:10px;align-items:center}
input,textarea{width:100%;padding:.55rem .7rem;border-radius:10px;border:1px solid #27313a;background:#0f1419;color:#e7eef6}
textarea{min-height:80px}
.btn{display:inline-flex;gap:.6rem;align-items:center;background:var(--brand);color:#fff;padding:.6rem .9rem;border-radius:999px;font-weight:700;border:2px solid transparent;cursor:pointer}
.btn.ghost{background:transparent;border-color:#2b333b}
.badge{padding:4px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.15);background:#5b1a1a}
.muted{color:#9aa7b3}
header{border-bottom:1px solid #1a2128;background:#0b0e11cc;backdrop-filter:blur(8px)}
header .bar{display:flex;align-items:center;gap:.6rem;padding:.6rem 0}
header a{display:flex;gap:.6rem;align-items:center;color:#eef2f6;text-decoration:none}
header img{height:40px}
.toast{position:fixed;right:16px;bottom:16px;background:#101519;border:1px solid #1b222a;border-radius:12px;padding:.7rem 1rem;display:none}
.toast.ok{background:#0f1a14;border-color:#1c3a2c}
.toast.err{background:#1a1010;border-color:#3a1c1c}
</style>

<header>
  <div class="container bar">
    <a href="index.html"><img src="assets/logo-ld-original.png" alt=""><strong>Back to site</strong></a>
  </div>
</header>

<div class="container" style="padding:24px 0 80px">

  <!-- GITHUB CONNECT -->
  <div class="card">
    <h2>Connect GitHub</h2>
    <div class="grid">
      <label>Owner</label><input id="gh_owner" placeholder="e.g. jonathonparker21-rgb">
      <label>Repo</label><input id="gh_repo" placeholder="e.g. ironwood-content">
      <label>Branch</label><input id="gh_branch" value="main" placeholder="main">
      <label>Token</label><input id="gh_token" type="password" placeholder="Fine-grained PAT (Contents: Read/Write)">
    </div>
    <div class="row" style="margin-top:10px">
      <button id="gh_save" class="btn">Save</button>
      <button id="gh_test" class="btn ghost">Test Connection</button>
      <span id="gh_status" class="badge">Not set</span>
    </div>
    <small class="muted">Stored only in your browser (localStorage). Token is used from your browser to api.github.com.</small>
  </div>

  <!-- SITE SETTINGS -->
  <div class="card" style="margin-top:16px">
    <h2>Site Settings</h2>
    <div class="grid">
      <label>Business Name</label><input id="biz_name" placeholder="Ironwood Land Development">
      <label>Public Phone</label><input id="biz_phone" placeholder="(318) 914-2351">
      <label>Click-to-call (+1...)</label><input id="biz_phone_raw" placeholder="+13189142351">
      <label>Hours</label><input id="biz_hours" placeholder="Mon–Sat 7a–6p">
      <label>Address (HTML)</label><textarea id="biz_address_html" placeholder="805 E. Main St&lt;br&gt;Oak Grove, LA 71263"></textarea>
      <label>Address (Text)</label><input id="biz_address_text" placeholder="805 E. Main St, Oak Grove, LA 71263">
      <label>Contact Email</label><input id="contact_email" placeholder="you@example.com">
    </div>
    <div class="row" style="margin-top:10px">
      <button id="settings_save" class="btn">Save Site Settings → config.json</button>
      <span id="settings_msg" class="muted"></span>
    </div>
  </div>

  <!-- BRANDING -->
  <div class="card" style="margin-top:16px">
    <h2>Branding</h2>
    <div class="row">
      <input id="logo_site" placeholder="Site logo URL (optional)">
      <input id="logo_dump" placeholder="Dumpsters logo URL (optional)">
    </div>
    <div class="row" style="margin-top:8px">
      <label style="display:grid;gap:6px"><span class="muted" style="font-size:.9rem">Brand</span><input id="brand_color" type="color" value="#dc2626"></label>
      <label style="display:grid;gap:6px"><span class="muted" style="font-size:.9rem">Accent</span><input id="accent_color" type="color" value="#fca5a5"></label>
    </div>
    <div class="row" style="margin-top:10px">
      <button id="branding_save" class="btn">Save Branding → config.json</button>
      <span id="branding_msg" class="muted"></span>
    </div>
  </div>

  <!-- DUMPSTERS -->
  <div class="card" style="margin-top:16px">
    <h2>Dumpsters</h2>
    <div class="grid">
      <label>Company</label><input id="dump_company" placeholder="Ironwood Trucking LLC">
      <label>Weekly Small ($)</label><input id="dump_small" type="number" placeholder="350">
      <label>Weekly Large ($)</label><input id="dump_large" type="number" placeholder="450">
      <label>Area</label><input id="dump_area" placeholder="Northeast Louisiana">
    </div>
    <div class="row" style="margin-top:10px">
      <button id="dump_save" class="btn">Save Dumpsters → config.json</button>
      <span id="dump_msg" class="muted"></span>
    </div>
  </div>

  <!-- VERSION -->
  <div class="card" style="margin-top:16px">
    <h2>Version</h2>
    <div class="row">
      <input id="ver_value" placeholder="1.2.0" style="max-width:220px">
      <button id="ver_write" class="btn">Write version.json</button>
      <span id="ver_msg" class="muted"></span>
    </div>
  </div>

</div>

<div id="toast" class="toast"></div>

<script>
/* ---------- helpers ---------- */
const $ = id => document.getElementById(id);
function toast(msg, ok=true){ const t=$('toast'); t.textContent=msg; t.className='toast '+(ok?'ok':'err'); t.style.display='block'; clearTimeout(window.__t); window.__t=setTimeout(()=>{t.style.display='none'}, 3000); }
function setBadge(txt, ok){ const el=$('gh_status'); el.textContent=txt; el.style.background=ok?'#065f46':'#5b1a1a'; }

function ghState(){
  try{
    const m=JSON.parse(localStorage.getItem('ironwood_gh')||'{}');
    return { owner:m.owner||'', repo:m.repo||'', branch:m.branch||'main', token:localStorage.getItem('ironwood_gh_token')||'' };
  }catch(e){ return { owner:'', repo:'', branch:'main', token:'' }; }
}

async function ghGet(path){
  const g=ghState(); if(!g.owner||!g.repo) throw new Error('Owner/Repo missing');
  const url=`https://api.github.com/repos/${g.owner}/${g.repo}/contents/${encodeURIComponent(path)}?ref=${encodeURIComponent(g.branch)}`;
  const r=await fetch(url,{ headers:g.token?{Authorization:`Bearer ${g.token}`}:{}, cache:'no-store' });
  if(!r.ok) return null; return r.json();
}

async function ghPut(path, text, message){
  const g=ghState(); if(!g.owner||!g.repo||!g.token) throw new Error('Owner/Repo/Token required');
  const existing = await ghGet(path);
  const body = { message: message || `update ${path}`, content: btoa(unescape(encodeURIComponent(text))), branch: g.branch };
  if(existing && existing.sha) body.sha = existing.sha;
  const url = `https://api.github.com/repos/${g.owner}/${g.repo}/contents/${encodeURIComponent(path)}`;
  const r = await fetch(url, { method:'PUT', headers:{ 'Authorization':`Bearer ${g.token}`, 'Content-Type':'application/json' }, body: JSON.stringify(body) });
  if(!r.ok){ const t=await r.text(); throw new Error(t||('HTTP '+r.status)); }
  return r.json();
}

async function loadConfig(){
  try{
    const r = await fetch('config.json', {cache:'no-store'});
    if(!r.ok) return null;
    return await r.json();
  }catch(e){ return null; }
}

function mergeConfig(base, patch){
  // shallow merge by top-level keys; nested objects also shallow-merged
  const out = Object.assign({}, base||{});
  for(const k in patch){
    if(patch[k] && typeof patch[k]==='object' && !Array.isArray(patch[k])){
      out[k] = Object.assign({}, out[k]||{}, patch[k]);
    }else{
      out[k] = patch[k];
    }
  }
  return out;
}

/* ---------- init fields ---------- */
(async function init(){
  // load saved GH creds
  const g=ghState();
  $('gh_owner').value=g.owner; $('gh_repo').value=g.repo; $('gh_branch').value=g.branch; $('gh_token').value=g.token;
  setBadge(g.owner && g.repo ? 'Saved' : 'Not set', !!(g.owner&&g.repo));

  // load config.json to UI
  const c = await loadConfig();
  if(c){
    $('biz_name').value = c.business?.name || 'Ironwood Land Development';
    $('biz_phone').value = c.business?.phone || '(318) 914-2351';
    $('biz_phone_raw').value = c.business?.phone_raw || '+13189142351';
    $('biz_hours').value = c.business?.hours || 'Mon–Sat 7a–6p';
    $('biz_address_html').value = c.business?.address_html || '805 E. Main St<br>Oak Grove, LA 71263';
    $('biz_address_text').value = c.business?.address_text || '805 E. Main St, Oak Grove, LA 71263';
    $('contact_email').value = c.contact_email || '';

    $('brand_color').value = c.theme?.brand || '#dc2626';
    $('accent_color').value = c.theme?.accent || '#fca5a5';
    $('logo_site').value = c.logos?.site || '';
    $('logo_dump').value = c.logos?.dumpsters || '';

    $('dump_company').value = c.dumpsters?.company || 'Ironwood Trucking LLC';
    $('dump_small').value = c.dumpsters?.weekly_small ?? 350;
    $('dump_large').value = c.dumpsters?.weekly_large ?? 450;
    $('dump_area').value  = c.dumpsters?.area || 'Northeast Louisiana';
  }
})();

/* ---------- actions ---------- */
$('gh_save').onclick = ()=>{
  const owner=$('gh_owner').value.trim(), repo=$('gh_repo').value.trim(), branch=($('gh_branch').value.trim()||'main'), token=$('gh_token').value.trim();
  if(!owner||!repo||!token){ setBadge('Missing',false); toast('Owner, Repo, and Token are required',false); return; }
  localStorage.setItem('ironwood_gh', JSON.stringify({owner,repo,branch}));
  localStorage.setItem('ironwood_gh_token', token);
  setBadge('Saved',true); toast('GitHub connection saved', true);
};

$('gh_test').onclick = async ()=>{
  try{
    const ok = await ghGet('config.json'); // read attempt
    setBadge(ok?'OK (config.json found)':'Repo reachable', !!ok);
    toast(ok?'Connected to repo.':'Repo reachable (config.json not found).', true);
  }catch(e){ setBadge('Failed',false); toast('Connection failed: '+e.message, false); }
};

$('settings_save').onclick = async ()=>{
  $('settings_msg').textContent='Saving...';
  try{
    const current = await loadConfig() || {};
    const patch = {
      business:{
        name: $('biz_name').value.trim()||'Ironwood Land Development',
        phone: $('biz_phone').value.trim()||'(318) 914-2351',
        phone_raw: $('biz_phone_raw').value.trim()||'+13189142351',
        hours: $('biz_hours').value.trim()||'Mon–Sat 7a–6p',
        address_html: $('biz_address_html').value.trim()||'805 E. Main St<br>Oak Grove, LA 71263',
        address_text: $('biz_address_text').value.trim()||'805 E. Main St, Oak Grove, LA 71263'
      },
      contact_email: $('contact_email').value.trim()||""
    };
    const cfg = mergeConfig(current, patch);
    await ghPut('config.json', JSON.stringify(cfg,null,2), 'admin: update site settings');
    $('settings_msg').textContent='Saved to GitHub ✅'; toast('Site settings saved', true);
  }catch(e){ $('settings_msg').textContent='Error'; toast('Save failed: '+e.message, false); }
};

$('branding_save').onclick = async ()=>{
  $('branding_msg').textContent='Saving...';
  try{
    const current = await loadConfig() || {};
    const patch = {
      theme: {
        brand: $('brand_color').value,
        accent: $('accent_color').value
      },
      logos: {
        site: $('logo_site').value.trim() || current.logos?.site || '',
        dumpsters: $('logo_dump').value.trim() || current.logos?.dumpsters || ''
      }
    };
    const cfg = mergeConfig(current, patch);
    await ghPut('config.json', JSON.stringify(cfg,null,2), 'admin: update branding');
    $('branding_msg').textContent='Saved to GitHub ✅'; toast('Branding saved', true);
  }catch(e){ $('branding_msg').textContent='Error'; toast('Save failed: '+e.message, false); }
};

$('dump_save').onclick = async ()=>{
  $('dump_msg').textContent='Saving...';
  try{
    const current = await loadConfig() || {};
    const patch = {
      dumpsters: {
        company: $('dump_company').value.trim() || 'Ironwood Trucking LLC',
        weekly_small: Number($('dump_small').value||350),
        weekly_large: Number($('dump_large').value||450),
        area: $('dump_area').value.trim() || 'Northeast Louisiana',
        includes_dump_fee: true
      }
    };
    const cfg = mergeConfig(current, patch);
    await ghPut('config.json', JSON.stringify(cfg,null,2), 'admin: update dumpsters');
    $('dump_msg').textContent='Saved to GitHub ✅'; toast('Dumpsters saved', true);
  }catch(e){ $('dump_msg').textContent='Error'; toast('Save failed: '+e.message, false); }
};

$('ver_write').onclick = async ()=>{
  $('ver_msg').textContent='Writing...';
  try{
    const version = $('ver_value').value.trim() || '1.2.0';
    const payload = { name:'ironwood-site', updated_at:new Date().toISOString(), branch:(ghState().branch||'main'), last_commit_sha:version, note:'admin write' };
    await ghPut('version.json', JSON.stringify(payload,null,2), 'admin: write version');
    $('ver_msg').textContent='version.json updated ✅'; toast('version.json written', true);
  }catch(e){ $('ver_msg').textContent='Error'; toast('Write failed: '+e.message, false); }
};
</script>
